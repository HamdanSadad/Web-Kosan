{% extends "base.html" %}

{% block title %}Admin Dashboard - Kosan Management{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        transition: transform 0.3s;
        border-radius: 12px;
        overflow: hidden;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .denah-container {
        position: relative;
        display: inline-block;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid #dee2e6;
        background: #fff;
    }

    .denah-img {
        max-width: 100%;
        height: auto;
    }

    .kamar-dot {
        position: absolute;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 2px solid white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: white;
        font-weight: bold;
        transform: translate(-50%, -50%);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 10;
        transition: transform 0.2s;
    }

    .kamar-dot:hover {
        transform: translate(-50%, -50%) scale(1.3);
        z-index: 20;
    }

    .status-terisi {
        background: linear-gradient(135deg, #ff416c, #ff4b2b);
    }

    .status-kosong {
        background: linear-gradient(135deg, #11998e, #38ef7d);
    }

    .status-nonaktif {
        background: linear-gradient(135deg, #5a5a5a, #b3b3b3);
    }

    .chart-container {
        min-height: 300px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="fw-bold text-dark">Dashboard Overview</h2>
            <p class="text-muted">Selamat datang kembali, Admin!</p>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card stat-card border-0 bg-primary text-white shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-0 text-white-50">Total Unit</p>
                            <h2 class="fw-bold mb-0">{{ total_kamar }}</h2>
                        </div>
                        <i class="fas fa-building fa-2x text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card border-0 bg-success text-white shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-0 text-white-50">Terisi</p>
                            <h2 class="fw-bold mb-0">{{ kamar_terisi }}</h2>
                        </div>
                        <i class="fas fa-user-check fa-2x text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card border-0 bg-info text-white shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-0 text-white-50">Kosong</p>
                            <h2 class="fw-bold mb-0">{{ kamar_kosong }}</h2>
                        </div>
                        <i class="fas fa-bed fa-2x text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card border-0 bg-danger text-white shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-0 text-white-50">Tunggakan</p>
                            <h2 class="fw-bold mb-0">{{ tunggakan }}</h2>
                        </div>
                        <i class="fas fa-exclamation-triangle fa-2x text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Interactive Plan -->
        <div class="col-xl-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h5 class="card-title fw-bold mb-0">Denah Kamar Interaktif</h5>
                </div>
                <div class="card-body text-center">
                    <div class="denah-container">
                        <img src="{{ url_for('static', filename='img/denah.jpg') }}" class="denah-img">
                        {% for kamar in kamar_list %}
                        <div class="kamar-dot status-{{ kamar.status | lower }}"
                            style="left: {{ kamar.pos_x }}%; top: {{ kamar.pos_y }}%;" data-bs-toggle="modal"
                            data-bs-target="#kamarModal" data-nomor="{{ kamar.nomor_kamar }}"
                            data-tipe="{{ kamar.tipe_kamar }}" data-harga="{{ kamar.harga }}"
                            data-status="{{ kamar.status }}" data-fasilitas="{{ kamar.fasilitas }}">
                            {{ kamar.nomor_kamar }}
                        </div>
                        {% endfor %}
                    </div>
                    <div class="mt-4 d-flex justify-content-center gap-3">
                        <small><span class="badge status-kosong p-2">&nbsp;&nbsp;</span> Kosong</small>
                        <small><span class="badge status-terisi p-2">&nbsp;&nbsp;</span> Terisi</small>
                        <small><span class="badge status-nonaktif p-2">&nbsp;&nbsp;</span> Nonaktif</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Column -->
        <div class="col-xl-4">
            <div class="row g-4 h-100">
                <div class="col-12">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-white py-3">
                            <h5 class="card-title fw-bold mb-0">Rasio Okupansi</h5>
                        </div>
                        <div class="card-body chart-container d-flex align-items-center">
                            <canvas id="occupancyChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white py-3">
                            <h5 class="card-title fw-bold mb-0">Statistik Keuangan</h5>
                        </div>
                        <div class="card-body chart-container">
                            <canvas id="financeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detail Kamar -->
<div class="modal fade" id="kamarModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Kamar <span id="modalNomor"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-6">
                        <label class="small text-muted d-block">Tipe</label>
                        <span id="modalTipe" class="fw-bold"></span>
                    </div>
                    <div class="col-6">
                        <label class="small text-muted d-block">Status</label>
                        <span id="modalStatus" class="badge"></span>
                    </div>
                    <div class="col-12">
                        <label class="small text-muted d-block">Harga Sewa</label>
                        <h4 class="text-primary fw-bold mb-0">Rp <span id="modalHarga"></span></h4>
                    </div>
                    <div class="col-12">
                        <label class="small text-muted d-block">Fasilitas</label>
                        <div id="modalFasilitas" class="p-3 bg-light rounded-3 small"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Tutup</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Data from Jinja2
    const dataTerisi = {{ kamar_terisi | tojson }};
    const dataKosong = {{ kamar_kosong | tojson }};

    // Occupancy Chart
    const ctxOccupancy = document.getElementById('occupancyChart').getContext('2d');
    new Chart(ctxOccupancy, {
        type: 'doughnut',
        data: {
            labels: ['Terisi', 'Kosong'],
            datasets: [{
                data: [dataTerisi, dataKosong],
                backgroundColor: ['#ff4b2b', '#38ef7d'],
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: {
            plugins: {
                legend: { position: 'bottom' }
            },
            cutout: '70%'
        }
    });

    // Finance Chart (Placeholder)
    const ctxFinance = document.getElementById('financeChart').getContext('2d');
    new Chart(ctxFinance, {
        type: 'bar',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun'],
            datasets: [{
                label: 'Pemasukan (Juta)',
                data: [12, 15, 11, 14, 18, 16],
                backgroundColor: 'rgba(13, 110, 253, 0.7)',
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // Modal Details Logic
    const kamarModal = document.getElementById('kamarModal');
    kamarModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const nomor = button.getAttribute('data-nomor');
        const tipe = button.getAttribute('data-tipe');
        const harga = parseFloat(button.getAttribute('data-harga')).toLocaleString('id-ID');
        const status = button.getAttribute('data-status');
        const fasilitas = button.getAttribute('data-fasilitas');

        document.getElementById('modalNomor').textContent = nomor;
        document.getElementById('modalTipe').textContent = tipe;
        document.getElementById('modalHarga').textContent = harga;

        const statusBadge = document.getElementById('modalStatus');
        statusBadge.textContent = status;
        statusBadge.className = 'badge ' + (status === 'Terisi' ? 'bg-danger' : (status === 'Kosong' ? 'bg-success' : 'bg-secondary'));

        document.getElementById('modalFasilitas').textContent = fasilitas || 'Tidak ada keterangan fasilitas tambahan.';
    });
</script>
{% endblock %}